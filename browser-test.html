<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestPro Browser Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ InvestPro Browser Test Suite</h1>
        <p>Testing the complete platform functionality through the browser</p>

        <!-- Registration Test -->
        <div class="test-section">
            <h3>üë§ User Registration Test</h3>
            <div>
                <input type="text" id="firstName" placeholder="First Name" value="Browser">
                <input type="text" id="lastName" placeholder="Last Name" value="Test">
            </div>
            <div>
                <input type="email" id="email" placeholder="Email" value="">
                <input type="password" id="password" placeholder="Password" value="BrowserTest123!">
            </div>
            <button onclick="testRegistration()">üîê Test Registration</button>
            <div id="registerResult"></div>
        </div>

        <!-- Login Test -->
        <div class="test-section">
            <h3>üîë User Login Test</h3>
            <div>
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password" value="BrowserTest123!">
            </div>
            <button onclick="testLogin()">üö™ Test Login</button>
            <div id="loginResult"></div>
        </div>

        <!-- Dashboard Test -->
        <div class="test-section">
            <h3>üìä Dashboard Test</h3>
            <button onclick="testDashboard()">üìà Test Dashboard Data</button>
            <div id="dashboardResult"></div>
        </div>

        <!-- Investment Packages Test -->
        <div class="test-section">
            <h3>üíº Investment Packages Test</h3>
            <button onclick="testPackages()">üì¶ Test Packages</button>
            <div id="packagesResult"></div>
        </div>

        <!-- Full Flow Test -->
        <div class="test-section">
            <h3>üéØ Complete Flow Test</h3>
            <button onclick="runCompleteFlow()">üöÄ Run Complete Test</button>
            <div id="completeResult"></div>
        </div>

        <!-- System Status -->
        <div class="test-section info">
            <h3>üîß System Status</h3>
            <p><strong>Frontend:</strong> <span id="frontendStatus">Checking...</span></p>
            <p><strong>Backend:</strong> <span id="backendStatus">Checking...</span></p>
            <p><strong>Database:</strong> <span id="databaseStatus">Checking...</span></p>
            <button onclick="checkSystemStatus()">üîÑ Refresh Status</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = '/api'; // Using Vite proxy
        
        // Generate unique email for testing
        function generateTestEmail() {
            return `browsertest${Date.now()}@test.com`;
        }

        // Utility function to display results
        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            element.className = `result ${success ? 'success' : 'error'}`;
            element.innerHTML = `
                <div class="status">${success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</div>
                <div>${message}</div>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
        }

        // Test Registration
        async function testRegistration() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value || generateTestEmail();
            const password = document.getElementById('password').value;

            // Update email field with generated email
            document.getElementById('email').value = email;
            document.getElementById('loginEmail').value = email;

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ firstName, lastName, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('registerResult', true, `Registration successful! User ID: ${data.user.id}`, data);
                } else {
                    showResult('registerResult', false, `Registration failed: ${data.error || 'Unknown error'}`, data);
                }
            } catch (error) {
                showResult('registerResult', false, `Network error: ${error.message}`);
            }
        }

        // Test Login
        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('loginResult', true, `Login successful! Welcome ${data.user.firstName}`, data);
                } else {
                    showResult('loginResult', false, `Login failed: ${data.error || 'Unknown error'}`, data);
                }
            } catch (error) {
                showResult('loginResult', false, `Network error: ${error.message}`);
            }
        }

        // Test Dashboard
        async function testDashboard() {
            try {
                // Test investments endpoint
                const investmentsResponse = await fetch(`${API_BASE}/investments`, {
                    credentials: 'include'
                });

                if (investmentsResponse.status === 401) {
                    showResult('dashboardResult', false, 'Please login first to test dashboard');
                    return;
                }

                const investmentsData = await investmentsResponse.json();

                // Test stats endpoint
                const statsResponse = await fetch(`${API_BASE}/investments/stats`, {
                    credentials: 'include'
                });
                const statsData = await statsResponse.json();

                if (investmentsResponse.ok && statsResponse.ok) {
                    showResult('dashboardResult', true, 
                        `Dashboard data loaded! ${investmentsData.investments.length} investments, $${statsData.summary.totalInvestment} total`,
                        { investments: investmentsData, stats: statsData });
                } else {
                    showResult('dashboardResult', false, 'Dashboard data failed to load');
                }
            } catch (error) {
                showResult('dashboardResult', false, `Network error: ${error.message}`);
            }
        }

        // Test Investment Packages
        async function testPackages() {
            try {
                const response = await fetch(`${API_BASE}/investments/packages`);
                const data = await response.json();

                if (response.ok) {
                    showResult('packagesResult', true, 
                        `${data.packages.length} investment packages loaded`, data);
                } else {
                    showResult('packagesResult', false, 'Failed to load packages');
                }
            } catch (error) {
                showResult('packagesResult', false, `Network error: ${error.message}`);
            }
        }

        // Run Complete Flow
        async function runCompleteFlow() {
            const resultElement = document.getElementById('completeResult');
            resultElement.innerHTML = '<div class="info">üöÄ Running complete flow test...</div>';

            const results = [];
            
            // Step 1: Register
            try {
                const email = generateTestEmail();
                const registerResponse = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        firstName: 'Flow',
                        lastName: 'Test',
                        email,
                        password: 'FlowTest123!'
                    })
                });
                const registerData = await registerResponse.json();
                results.push({ step: 'Registration', success: registerResponse.ok, data: registerData });

                if (registerResponse.ok) {
                    // Step 2: Login
                    const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ email, password: 'FlowTest123!' })
                    });
                    const loginData = await loginResponse.json();
                    results.push({ step: 'Login', success: loginResponse.ok, data: loginData });

                    if (loginResponse.ok) {
                        // Step 3: Dashboard
                        const dashResponse = await fetch(`${API_BASE}/investments`, { credentials: 'include' });
                        const dashData = await dashResponse.json();
                        results.push({ step: 'Dashboard', success: dashResponse.ok, data: dashData });

                        // Step 4: Stats
                        const statsResponse = await fetch(`${API_BASE}/investments/stats`, { credentials: 'include' });
                        const statsData = await statsResponse.json();
                        results.push({ step: 'Stats', success: statsResponse.ok, data: statsData });
                    }
                }
            } catch (error) {
                results.push({ step: 'Error', success: false, error: error.message });
            }

            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            showResult('completeResult', successCount === totalCount, 
                `Complete flow test: ${successCount}/${totalCount} steps passed`, results);
        }

        // Check System Status
        async function checkSystemStatus() {
            // Frontend status
            try {
                const frontendResponse = await fetch('/');
                document.getElementById('frontendStatus').innerHTML = 
                    frontendResponse.ok ? 'üü¢ Online' : 'üî¥ Offline';
            } catch {
                document.getElementById('frontendStatus').innerHTML = 'üî¥ Offline';
            }

            // Backend status
            try {
                const backendResponse = await fetch(`${API_BASE}/health`);
                const backendData = await backendResponse.json();
                document.getElementById('backendStatus').innerHTML = 
                    backendResponse.ok ? `üü¢ Online (${backendData.environment})` : 'üî¥ Offline';
                document.getElementById('databaseStatus').innerHTML = 
                    backendData.database === 'connected' ? 'üü¢ Connected' : 'üî¥ Disconnected';
            } catch {
                document.getElementById('backendStatus').innerHTML = 'üî¥ Offline';
                document.getElementById('databaseStatus').innerHTML = 'üî¥ Unknown';
            }
        }

        // Initialize on page load
        window.onload = function() {
            checkSystemStatus();
            // Generate initial test email
            document.getElementById('email').value = generateTestEmail();
        };
    </script>
</body>
</html>